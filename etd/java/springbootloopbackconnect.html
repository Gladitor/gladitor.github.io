<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Springboot 应用 loopbackconnector 分析 | Jiay</title>
    <meta name="description" content="千里之行始于足下">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.7be88f66.css" as="style"><link rel="preload" href="/assets/js/app.bdf7c7a6.js" as="script"><link rel="preload" href="/assets/js/2.9cff2c17.js" as="script"><link rel="preload" href="/assets/js/10.a5aa0d04.js" as="script"><link rel="prefetch" href="/assets/js/11.e144e3b1.js"><link rel="prefetch" href="/assets/js/12.9405f2f3.js"><link rel="prefetch" href="/assets/js/13.0018d213.js"><link rel="prefetch" href="/assets/js/14.48adb982.js"><link rel="prefetch" href="/assets/js/15.aa9d6f85.js"><link rel="prefetch" href="/assets/js/16.533ac02d.js"><link rel="prefetch" href="/assets/js/17.7fbf903a.js"><link rel="prefetch" href="/assets/js/18.7f1a42fb.js"><link rel="prefetch" href="/assets/js/19.a80f536a.js"><link rel="prefetch" href="/assets/js/20.c696dd31.js"><link rel="prefetch" href="/assets/js/21.e085b4c8.js"><link rel="prefetch" href="/assets/js/22.79b44f56.js"><link rel="prefetch" href="/assets/js/23.11abf498.js"><link rel="prefetch" href="/assets/js/24.2e1049ab.js"><link rel="prefetch" href="/assets/js/25.e89b8920.js"><link rel="prefetch" href="/assets/js/26.0a5932cd.js"><link rel="prefetch" href="/assets/js/27.97588e61.js"><link rel="prefetch" href="/assets/js/28.c0d1055a.js"><link rel="prefetch" href="/assets/js/29.1d178c0b.js"><link rel="prefetch" href="/assets/js/3.49e1eb31.js"><link rel="prefetch" href="/assets/js/30.c10dee8d.js"><link rel="prefetch" href="/assets/js/31.820f6d63.js"><link rel="prefetch" href="/assets/js/32.20483bc4.js"><link rel="prefetch" href="/assets/js/33.4429aa45.js"><link rel="prefetch" href="/assets/js/34.49ae852a.js"><link rel="prefetch" href="/assets/js/35.00062646.js"><link rel="prefetch" href="/assets/js/36.04f356f7.js"><link rel="prefetch" href="/assets/js/37.4bb3d02d.js"><link rel="prefetch" href="/assets/js/38.56c5d74f.js"><link rel="prefetch" href="/assets/js/39.35e19386.js"><link rel="prefetch" href="/assets/js/4.969442f0.js"><link rel="prefetch" href="/assets/js/40.bc3ffe23.js"><link rel="prefetch" href="/assets/js/41.08a041c2.js"><link rel="prefetch" href="/assets/js/42.01727b78.js"><link rel="prefetch" href="/assets/js/43.c3d124e5.js"><link rel="prefetch" href="/assets/js/44.3ab5b8dd.js"><link rel="prefetch" href="/assets/js/45.13edc4d5.js"><link rel="prefetch" href="/assets/js/5.59319145.js"><link rel="prefetch" href="/assets/js/6.a3a764a3.js"><link rel="prefetch" href="/assets/js/7.5610ed62.js"><link rel="prefetch" href="/assets/js/8.6516be4e.js"><link rel="prefetch" href="/assets/js/9.d05f3fed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7be88f66.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jiay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/about/" class="sidebar-link">about</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>exp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>etd</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/etd/springcloud.html" class="sidebar-link">SpringCloud</a></li><li><a href="/etd/java/passbyvalue.html" class="sidebar-link">关于java中只有值传递的思考</a></li><li><a href="/etd/interview/javaArchitect.html" class="sidebar-link">Interview</a></li><li><a href="/etd/java/springbootloopbackconnect.html" class="active sidebar-link">Springboot 应用 loopbackconnector 分析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>issues</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>life</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springboot-应用-loopbackconnector-分析"><a href="#springboot-应用-loopbackconnector-分析" aria-hidden="true" class="header-anchor">#</a> Springboot 应用 loopbackconnector 分析</h1> <h5 id="自连接现象"><a href="#自连接现象" aria-hidden="true" class="header-anchor">#</a> 自连接现象</h5> <p>客户反馈服务器上应用启动时无端开启一些 TCP 端口监听，占用系统资源，造成浪费。本着不放过任何一个问题的原则，使用 netstat 查看确实存在一些 tcp 链路，并且这些链路都是 loopback，但没有端口监听，说明是连接建立后关闭了端口监听。
<img src="/assets/img/connects.377c4f5a.png" alt="connects"></p> <h5 id="jfr、jmc-和应用-capture-分析"><a href="#jfr、jmc-和应用-capture-分析" aria-hidden="true" class="header-anchor">#</a> JFR、JMC 和应用 capture 分析</h5> <p><strong>1.设置 JFR 配置文件</strong><br> <img src="/assets/img/jfc.19aec09e.png" alt="jfc"><br>
从 JDK 目录下 JRE 中 lib/jfr 中复制 default.jfc，对配置文件进行修改，增加 socket 相关事件记录，如上图所示</p> <p><strong>2.启动应用获取 JFR</strong></p> <div class="language- extra-class"><pre class="language-text"><code> java -XX:+UnlockCommercialFeatures -XX:StartFlightRecording=duration=90s,filename=myrecording.jfr,settings=D:\taskDemo\JavaTaskDemo\javabase\springbootdemo\target\default.jfc -jar .\springbootdemo-0.0.1-SNAPSHOT.jar
</code></pre></div><p>通过指定自定义配置文件，settings=xxx.jfc，生成 myrecording.jfr 文件。</p> <p><strong>3.使用 JMC 对 JFR 文件进行分析</strong><br>
启动 JMC 软件，打开 JFR 的 myrecording.jfr 文件进行事件分析，发现应用启动时确实存在 socket event 中的数据发送，数据有 16 个字节，无法看到数据内容<br> <img src="/assets/img/jmc1.97e8dbbe.png" alt="jmc1"><br>
同时调用堆栈展示如下：<br> <img src="/assets/img/jmc2.db3d99a8.png" alt="jmc2"></p> <p><strong>4.wireshark 抓包分析</strong><br>
JFR 能够记录到链路数据发送长度，但无法得到链路发送的具体内容，于是使用 wireshark 进行数据抓包<br> <img src="/assets/img/wireshark1.c7550fb0.png" alt="wireshark1"><br> <img src="/assets/img/wireshark2.4c9874e6.png" alt="wireshark2"><br>
应用启动时确实有 TCP 自连接建立并发送数据，但每次数据内容是随机的</p> <h5 id="源码分析"><a href="#源码分析" aria-hidden="true" class="header-anchor">#</a> 源码分析</h5> <p>是谁在应用启动时进行 TCP 自连接并发送数据，Maven 下载依赖源码，进行源码分析。根据 JMC 中对堆栈的记录查找数据发送源码位置<br> <img src="/assets/img/sourcecode.35238a37.png" alt="sourcecode"><br>
源码中可以看出应用启动时进行了链路连接监测，发送和接收数据一致的情况下说明通信没有问题，若是数据不一致则一直进行验证，这就会造成很多自连接的情况出现</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/27/2024, 7:27:55 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/etd/interview/javaArchitect.html" class="prev">
          Interview
        </a></span> <span class="next"><a href="/issues/cxfclient.html">
          错误：编码GBK的不可映射字符
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.bdf7c7a6.js" defer></script><script src="/assets/js/2.9cff2c17.js" defer></script><script src="/assets/js/10.a5aa0d04.js" defer></script>
  </body>
</html>
