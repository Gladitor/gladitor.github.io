<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Springboot 应用 loopbackconnector 分析 | Jiay</title>
    <meta name="description" content="千里之行始于足下">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.7be88f66.css" as="style"><link rel="preload" href="/assets/js/app.525c4e05.js" as="script"><link rel="preload" href="/assets/js/2.d1b97b8f.js" as="script"><link rel="preload" href="/assets/js/10.2bc435a7.js" as="script"><link rel="prefetch" href="/assets/js/11.b213e0a2.js"><link rel="prefetch" href="/assets/js/12.e7296e63.js"><link rel="prefetch" href="/assets/js/13.4ce13c3b.js"><link rel="prefetch" href="/assets/js/14.d20c3f83.js"><link rel="prefetch" href="/assets/js/15.5012b64a.js"><link rel="prefetch" href="/assets/js/16.54ef9ea5.js"><link rel="prefetch" href="/assets/js/17.903ea013.js"><link rel="prefetch" href="/assets/js/18.819140f0.js"><link rel="prefetch" href="/assets/js/19.629b8889.js"><link rel="prefetch" href="/assets/js/20.b0491244.js"><link rel="prefetch" href="/assets/js/21.ab831d40.js"><link rel="prefetch" href="/assets/js/22.fea43e50.js"><link rel="prefetch" href="/assets/js/23.a361c341.js"><link rel="prefetch" href="/assets/js/24.71c8f0e5.js"><link rel="prefetch" href="/assets/js/25.f5ae2629.js"><link rel="prefetch" href="/assets/js/26.ee4a8d01.js"><link rel="prefetch" href="/assets/js/27.7ae73063.js"><link rel="prefetch" href="/assets/js/28.4e36fdd0.js"><link rel="prefetch" href="/assets/js/29.36436c31.js"><link rel="prefetch" href="/assets/js/3.baeba3dc.js"><link rel="prefetch" href="/assets/js/30.9576c7bf.js"><link rel="prefetch" href="/assets/js/31.4315cc9a.js"><link rel="prefetch" href="/assets/js/32.659b8ab9.js"><link rel="prefetch" href="/assets/js/33.fbf5aa9a.js"><link rel="prefetch" href="/assets/js/34.84ac7cda.js"><link rel="prefetch" href="/assets/js/35.412df520.js"><link rel="prefetch" href="/assets/js/36.0a0b721e.js"><link rel="prefetch" href="/assets/js/37.6d214f93.js"><link rel="prefetch" href="/assets/js/38.538c2c96.js"><link rel="prefetch" href="/assets/js/39.e89ddb26.js"><link rel="prefetch" href="/assets/js/4.9a651fe1.js"><link rel="prefetch" href="/assets/js/40.c71ad779.js"><link rel="prefetch" href="/assets/js/41.352b3a3c.js"><link rel="prefetch" href="/assets/js/42.1fdae934.js"><link rel="prefetch" href="/assets/js/43.0b39c1f1.js"><link rel="prefetch" href="/assets/js/44.0b50c790.js"><link rel="prefetch" href="/assets/js/5.b3c68399.js"><link rel="prefetch" href="/assets/js/6.07d8b0e7.js"><link rel="prefetch" href="/assets/js/7.a5393509.js"><link rel="prefetch" href="/assets/js/8.bb123cc7.js"><link rel="prefetch" href="/assets/js/9.caccd1ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7be88f66.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jiay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/about/" class="sidebar-link">about</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>exp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>etd</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/etd/springcloud.html" class="sidebar-link">SpringCloud</a></li><li><a href="/etd/java/passbyvalue.html" class="sidebar-link">关于java中只有值传递的思考</a></li><li><a href="/etd/interview/javaArchitect.html" class="sidebar-link">Interview</a></li><li><a href="/etd/java/springbootloopbackconnect.html" class="active sidebar-link">Springboot 应用 loopbackconnector 分析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>issues</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>life</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springboot-应用-loopbackconnector-分析"><a href="#springboot-应用-loopbackconnector-分析" aria-hidden="true" class="header-anchor">#</a> Springboot 应用 loopbackconnector 分析</h1> <h5 id="自连接现象"><a href="#自连接现象" aria-hidden="true" class="header-anchor">#</a> 自连接现象</h5> <p>客户反馈服务器上应用启动时无端开启一些 TCP 端口监听，占用系统资源，造成浪费。本着不放过任何一个问题的原则，使用 netstat 查看确实存在一些 tcp 链路，并且这些链路都是 loopback，但没有端口监听，说明是连接建立后关闭了端口监听。
<img src="/assets/img/connects.377c4f5a.png" alt="connects"></p> <h5 id="jfr、jmc-和应用-capture-分析"><a href="#jfr、jmc-和应用-capture-分析" aria-hidden="true" class="header-anchor">#</a> JFR、JMC 和应用 capture 分析</h5> <p><strong>1.设置 JFR 配置文件</strong><br> <img src="/assets/img/jfc.19aec09e.png" alt="jfc"><br>
从 JDK 目录下 JRE 中 lib/jfr 中复制 default.jfc，对配置文件进行修改，增加 socket 相关事件记录，如上图所示</p> <p><strong>2.启动应用获取 JFR</strong></p> <div class="language- extra-class"><pre class="language-text"><code> java -XX:+UnlockCommercialFeatures -XX:StartFlightRecording=duration=90s,filename=myrecording.jfr,settings=D:\taskDemo\JavaTaskDemo\javabase\springbootdemo\target\default.jfc -jar .\springbootdemo-0.0.1-SNAPSHOT.jar
</code></pre></div><p>通过指定自定义配置文件，settings=xxx.jfc，生成 myrecording.jfr 文件。</p> <p><strong>3.使用 JMC 对 JFR 文件进行分析</strong><br>
启动 JMC 软件，打开 JFR 的 myrecording.jfr 文件进行事件分析，发现应用启动时确实存在 socket event 中的数据发送，数据有 16 个字节，无法看到数据内容<br> <img src="/assets/img/jmc1.97e8dbbe.png" alt="jmc1"><br>
同时调用堆栈展示如下：<br> <img src="/assets/img/jmc2.db3d99a8.png" alt="jmc2"></p> <p><strong>4.wireshark 抓包分析</strong><br>
JFR 能够记录到链路数据发送长度，但无法得到链路发送的具体内容，于是使用 wireshark 进行数据抓包<br> <img src="/assets/img/wireshark1.c7550fb0.png" alt="wireshark1"><br> <img src="/assets/img/wireshark2.4c9874e6.png" alt="wireshark2"><br>
应用启动时确实有 TCP 自连接建立并发送数据，但每次数据内容是随机的</p> <h5 id="源码分析"><a href="#源码分析" aria-hidden="true" class="header-anchor">#</a> 源码分析</h5> <p>是谁在应用启动时进行 TCP 自连接并发送数据，Maven 下载依赖源码，进行源码分析。根据 JMC 中对堆栈的记录查找数据发送源码位置<br> <img src="/assets/img/sourcecode.35238a37.png" alt="sourcecode"><br>
源码中可以看出应用启动时进行了链路连接监测，发送和接收数据一致的情况下说明通信没有问题，若是数据不一致则一直进行验证，这就会造成很多自连接的情况出现</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/etd/interview/javaArchitect.html" class="prev">
          Interview
        </a></span> <span class="next"><a href="/issues/cxfclient.html">
          错误：编码GBK的不可映射字符
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.525c4e05.js" defer></script><script src="/assets/js/2.d1b97b8f.js" defer></script><script src="/assets/js/10.2bc435a7.js" defer></script>
  </body>
</html>
