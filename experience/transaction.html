<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事务 | Jiay</title>
    <meta name="description" content="welcome!">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.7be88f66.css" as="style"><link rel="preload" href="/assets/js/app.cdb51286.js" as="script"><link rel="preload" href="/assets/js/2.00c0ffb2.js" as="script"><link rel="preload" href="/assets/js/3.64b9d492.js" as="script"><link rel="preload" href="/assets/js/19.8e3af826.js" as="script"><link rel="prefetch" href="/assets/js/10.5eccf3da.js"><link rel="prefetch" href="/assets/js/11.1471f388.js"><link rel="prefetch" href="/assets/js/12.134c45fe.js"><link rel="prefetch" href="/assets/js/13.7d78f196.js"><link rel="prefetch" href="/assets/js/14.032becbf.js"><link rel="prefetch" href="/assets/js/15.783b70d6.js"><link rel="prefetch" href="/assets/js/16.fe1c6d5a.js"><link rel="prefetch" href="/assets/js/17.95bb5c1e.js"><link rel="prefetch" href="/assets/js/18.53e48e4f.js"><link rel="prefetch" href="/assets/js/20.ebc9abfd.js"><link rel="prefetch" href="/assets/js/21.6679fe29.js"><link rel="prefetch" href="/assets/js/22.1ba008f9.js"><link rel="prefetch" href="/assets/js/23.0c9b9f03.js"><link rel="prefetch" href="/assets/js/24.5e30ab97.js"><link rel="prefetch" href="/assets/js/25.69a346b3.js"><link rel="prefetch" href="/assets/js/26.501bc341.js"><link rel="prefetch" href="/assets/js/27.6905787f.js"><link rel="prefetch" href="/assets/js/28.07fa8e91.js"><link rel="prefetch" href="/assets/js/29.c7fcc995.js"><link rel="prefetch" href="/assets/js/30.ebb2fc83.js"><link rel="prefetch" href="/assets/js/31.9f6ef201.js"><link rel="prefetch" href="/assets/js/32.4b46976a.js"><link rel="prefetch" href="/assets/js/33.62f7f6e5.js"><link rel="prefetch" href="/assets/js/34.e8c7addf.js"><link rel="prefetch" href="/assets/js/35.60cb45c9.js"><link rel="prefetch" href="/assets/js/36.8de793c6.js"><link rel="prefetch" href="/assets/js/37.2e0bf14c.js"><link rel="prefetch" href="/assets/js/38.47905322.js"><link rel="prefetch" href="/assets/js/39.e43b39f4.js"><link rel="prefetch" href="/assets/js/4.d64aaba9.js"><link rel="prefetch" href="/assets/js/40.6ae86537.js"><link rel="prefetch" href="/assets/js/5.a33a8d27.js"><link rel="prefetch" href="/assets/js/6.203ec74d.js"><link rel="prefetch" href="/assets/js/7.3097b3e4.js"><link rel="prefetch" href="/assets/js/8.0cda83a9.js"><link rel="prefetch" href="/assets/js/9.72bbae87.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7be88f66.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jiay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/about/" class="sidebar-link">about</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>exp</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/experience/" class="sidebar-link">ExcelHandler</a></li><li><a href="/experience/jacksonbase.html" class="sidebar-link">Jackson基本用法</a></li><li><a href="/experience/webservice.html" class="sidebar-link">Cxf实现webservice实战入门</a></li><li><a href="/experience/webservicebasedspringboot.html" class="sidebar-link">基于SpringBoot、Cxf实现webservice</a></li><li><a href="/experience/gRPC.html" class="sidebar-link">gRPC实战总结</a></li><li><a href="/experience/liquibase.html" class="sidebar-link">liquibase实战</a></li><li><a href="/experience/transaction.html" class="active sidebar-link">事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/experience/transaction.html#场景" class="sidebar-link">场景</a></li><li class="sidebar-sub-header"><a href="/experience/transaction.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/experience/transaction.html#属性" class="sidebar-link">属性</a></li><li class="sidebar-sub-header"><a href="/experience/transaction.html#传播机制" class="sidebar-link">传播机制</a></li><li class="sidebar-sub-header"><a href="/experience/transaction.html#隔离级别" class="sidebar-link">隔离级别</a></li><li class="sidebar-sub-header"><a href="/experience/transaction.html#mysql隔离级别测试" class="sidebar-link">MySQL隔离级别测试</a></li></ul></li><li><a href="/experience/springboot-swagger2.html" class="sidebar-link">springboot-shiro项目集成swagger2</a></li><li><a href="/experience/datax.html" class="sidebar-link">DataX --alibaba</a></li><li><a href="/experience/fiddler-nox.html" class="sidebar-link">fiddler+nox对android抓包实战</a></li><li><a href="/experience/xxnet.html" class="sidebar-link">xx-net科学上网教程</a></li><li><a href="/experience/rsyncforwindows.html" class="sidebar-link">rsync在windows下应用免费版</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>etd</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>issues</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>life</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="事务"><a href="#事务" aria-hidden="true" class="header-anchor">#</a> 事务</h1> <h2 id="场景"><a href="#场景" aria-hidden="true" class="header-anchor">#</a> 场景</h2> <p>想象一个电商分享APP中的用户注册过程，添加用户-&gt;为用户分配邀请码-&gt;为用户分配跟单标识。<br>
添加用户、分配邀请码、分配跟单标识这三个数据库动作必须同时完成注册才能成功，只要有一个失败注册就是失败，而且可能会造成脏乱数据，因此需要使用事务，有一个失败就必须回滚保证数据库数据正确。</p> <h2 id="定义"><a href="#定义" aria-hidden="true" class="header-anchor">#</a> 定义</h2> <p>计算机中访问并可能更新数据库中各数据项的程序执行单元。</p> <h2 id="属性"><a href="#属性" aria-hidden="true" class="header-anchor">#</a> 属性</h2> <p>事务具有ACID四个属性。</p> <ul><li>A(atomicity)原子性<br>
最小的程序执行单元。要么都做，要么不做。事务只有2种结果，所有的数据库操作全部完成并提交或发生错误撤销所有操作到事务开始时的状态。</li> <li>C(consistency)一致性<br>
使数据库从一个一致性状态变为另一个一致性状态，与原子性是密切相关的。</li> <li>I(isolation)隔离性<br>
一个事务的执行不能被其它事务干扰。即一个事务内部的操作和使用的数据对并发的其它事务是隔离的。</li> <li>D(durability)持久性<br>
一个事务一旦提交它对数据库的修改就是永久性的。</li></ul> <h2 id="传播机制"><a href="#传播机制" aria-hidden="true" class="header-anchor">#</a> 传播机制</h2> <p>以Spring事务传播机制为例，Spring在TransactionDefinition接口中定义了7个事务传播行为：</p> <ul><li>propagation_requierd<br>
如果当前没有事务就新建一个事务，如果已经存在一个事务就加入这个事务中。这是最常用的方式。</li> <li>propagation_supports<br>
支持当前事务，如果没有当前事务就以非事务方法执行。</li> <li>propagation_mandatory<br>
使用当前事务，没有则抛出异常。</li> <li>propagation_requierd_new<br>
新建事务，如果当前存在事务则把当前事务挂起。</li> <li>propagation_not_supported<br>
以非事务方式执行，如果存在当前事务，就把当前事务挂起。</li> <li>propagation_never<br>
以非事务方式执行，如果当前事务存在则抛出异常。</li> <li>propagation_nested<br>
如果当前存在事务则在嵌套事务内执行，如果不存在则执行类似propagation_requierd的操作。</li></ul> <h2 id="隔离级别"><a href="#隔离级别" aria-hidden="true" class="header-anchor">#</a> 隔离级别</h2> <p>SQL标准定义了4种隔离级别，包括一些具体规则来限定事务内外的哪些改变是可见的哪些改变是不可见的。一般低隔离级别支持更高的并发，并拥有更低的系统开销。</p> <ul><li>(1)Read Uncommitted(读未提交-脏读)<br>
字面理解就是读到了别人未提交的数据。A事务执行过程种读到了B事务修改但未提交的数据，产生脏读。这个级别很少实际应用，因为它的性能比其它级别好不了多少。</li> <li>(2)Read Committed(读已提交-不可重复读)<br>
大多数数据库的默认隔离级别，A事务执行过程种B事务更改了数据M，A读取M时是B更改后的。</li> <li>(3)Repeatable Read(可重复读-幻读)<br>
这是MYSQL的默认隔离级别，它确保同一事务的多个实例在并发读取数据时会看到同样的行。理论上会造成幻读，A事务在读取数据时B事务插入了新的行，A事务再读取数据时发现有新的幻影行。InnoDB和FaIcon通过MVCC(Multiversion concurrency control)机制解决了这个问题。</li> <li>(4)Serializable(串行化)<br>
这是最高的隔离级别，强制事务排序，使之不可能相互冲突。但可能会造成大量的超时现象和锁竞争。</li></ul> <h2 id="mysql隔离级别测试"><a href="#mysql隔离级别测试" aria-hidden="true" class="header-anchor">#</a> MySQL隔离级别测试</h2> <ul><li>(1)、Read Uncommitted<br>
首先开启2个命令行客户端连接本地的mysql服务。两个客户端此处命名左边为A，右边为B。<br> <img src="/assets/img/connect.f384b5c3.png" alt="connect"><br>
设置A的隔离级别为Read Uncommitted。<br> <img src="/assets/img/a_isolation_ru.4e99cb8e.png" alt="a_isolation_ru"><br>
启动事务，查询User。<br> <img src="/assets/img/a_startt_ru.860209c9.png" alt="a_startt_ru"><br>
B开启事务，更改jiay的age为10但不提交。A查询当前数据，数据发生改变。<br> <img src="/assets/img/a_result_ru.b0848f43.png" alt="a_result_ru"><br>
B回滚事务，A查看当前数据，数据还原。<br> <img src="/assets/img/rollback_ru.de72ce94.png" alt="rollback_ru"><br>
由此可以看出读未提交会造成脏读。</li> <li>(2)、Read Committed<br>
还是2个客户端，左边A，右边B。<br>
设置A的隔离级别Read Committed，A、B分别开启事务，查看User数据。<br> <img src="/assets/img/2_startt_rc.2c462940.png" alt="2_startt_rc"><br>
B更改jiay的age为10但不提交。A查询当前数据，数据没有发生改变。不会出现脏读。<br> <img src="/assets/img/2_result_rc.dc40442b.png" alt="2_result_rc"><br>
B提交事务，A查询当前数据，数据发生改变。B事务提交的数据被A事务读到了，这就会出现不可重复读。<br> <img src="/assets/img/2_result2_rc.4644f35e.png" alt="2_result2_rc"><br>
由此可以看出读已提交解决了脏读问题，但还会有不可重复读的问题。</li> <li>(3)、Repeatable Read<br>
还是2个客户端，左边A，右边B。<br>
A、B分别开启事务，查看User数据。<br> <img src="/assets/img/3_startt_rr.eb9d833c.png" alt="3_startt_rr"><br>
B更改jiay的age为1但不提交。A查询当前数据，数据没有发生改变。不会出现脏读。<br> <img src="/assets/img/3_result1_rr.e3297fa6.png" alt="3_result1_rr"><br>
B提交事务，A查询当前数据，数据没有发生改变。不会出现不可重复读。<br> <img src="/assets/img/3_result2_rr.cf21f2e2.png" alt="3_result2_rr"><br>
B插入一个用户jone，主键4ba03142-5d1b-11ea-b76b-e86a647ee7f5，A查询当前数据，数据依然没有发生改变。没有查询到最新数据出现幻读。<br> <img src="/assets/img/3_result3_rr.10da444c.png" alt="3_result3_rr"></li> <li>幻读的影响<br>
A、B查看User数据，B的结果是有jone的。<br> <img src="/assets/img/3_result4_rr.2df4bd6f.png" alt="3_result4_rr"><br>
此时若是A事务中要新增一个记录到User，主键也是4ba03142-5d1b-11ea-b76b-e86a647ee7f5就会出现问题，MySQL中很多情况主键是自增就会更容易抛出异常，主键冲突，怎么会这样，是幻觉吗？这就是幻读。<br> <img src="/assets/img/3_result5_rr.a5207c53.png" alt="3_result5_rr"><br>
A提交事务后查询User。正常代码中这次注册就失败了，这里为了明确状况，提交事务后再查询结果确实有一个jone用户主键冲突。<br> <img src="/assets/img/3_result6_rr.4f912f48.png" alt="3_result6_rr"></li> <li>(4)、Serializable<br>
依然2个客户端，左边A，右边B。<br>
设置A的隔离级别Serializable，A、B分别开启事务，查看User数据，B事务尝试更改jiay的age为30，B进入等待状态。<br> <img src="/assets/img/4_result1_s.e869ad30.png" alt="4_result1_s"><br>
这是因为A事务未提交，B进入等待，等待超时后抛出异常。<br> <img src="/assets/img/4_result2_s.9bd55f37.png" alt="4_result2_s"><br>
A提交事务，B再次尝试更改jiay的age为30，执行成功。<br> <img src="/assets/img/4_result3_s.708aa42a.png" alt="4_result3_s"><br>
A查询User数据，数据没有发生变化，这是可重复读机制保证的结果，这正符合MySQL的隔离级别设计。<br> <img src="/assets/img/4_result4_s.ba0e6966.png" alt="4_result4_s"><br>
B提交事务，A再查询，数据是更新后的最新数据。<br> <img src="/assets/img/4_result5_s.7844f106.png" alt="4_result5_s"><br>
serializable会锁定对应的数据表格，因而会有效率的问题。</li></ul> <div><h2>欢迎来访</h2> <ul><li>有问题欢迎留言或加交流qq:825121848</li> <li>转载请注明出处</li> <li>请小编喝茶~<br><img src="/assets/img/wx.dc92fb1a.png"></li></ul></div> <!----></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/experience/liquibase.html" class="prev">
          liquibase实战
        </a></span> <span class="next"><a href="/experience/springboot-swagger2.html">
          springboot-shiro项目集成swagger2
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cdb51286.js" defer></script><script src="/assets/js/2.00c0ffb2.js" defer></script><script src="/assets/js/3.64b9d492.js" defer></script><script src="/assets/js/19.8e3af826.js" defer></script>
  </body>
</html>
