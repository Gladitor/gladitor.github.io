<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C# DataTable并发操作:索引超出了数组界限 | Jiay</title>
    <meta name="description" content="千里之行始于足下">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.7be88f66.css" as="style"><link rel="preload" href="/assets/js/app.92570aa3.js" as="script"><link rel="preload" href="/assets/js/2.cb3e19ad.js" as="script"><link rel="preload" href="/assets/js/41.6ccc4d68.js" as="script"><link rel="preload" href="/assets/js/20.b41657ac.js" as="script"><link rel="prefetch" href="/assets/js/10.45112065.js"><link rel="prefetch" href="/assets/js/11.468ccf66.js"><link rel="prefetch" href="/assets/js/12.a42945e2.js"><link rel="prefetch" href="/assets/js/13.f1fc09c6.js"><link rel="prefetch" href="/assets/js/14.a87deeee.js"><link rel="prefetch" href="/assets/js/15.4ac044e1.js"><link rel="prefetch" href="/assets/js/16.3cb817b4.js"><link rel="prefetch" href="/assets/js/17.b4ea8e5d.js"><link rel="prefetch" href="/assets/js/18.cff23092.js"><link rel="prefetch" href="/assets/js/19.8f67407c.js"><link rel="prefetch" href="/assets/js/21.21ca19df.js"><link rel="prefetch" href="/assets/js/22.d85d338d.js"><link rel="prefetch" href="/assets/js/23.3bd64c3f.js"><link rel="prefetch" href="/assets/js/24.2640921d.js"><link rel="prefetch" href="/assets/js/25.a1024a0f.js"><link rel="prefetch" href="/assets/js/26.6c7b15c6.js"><link rel="prefetch" href="/assets/js/27.78b697d3.js"><link rel="prefetch" href="/assets/js/28.930d293a.js"><link rel="prefetch" href="/assets/js/29.8f52dbea.js"><link rel="prefetch" href="/assets/js/3.0312b492.js"><link rel="prefetch" href="/assets/js/30.b075cd5c.js"><link rel="prefetch" href="/assets/js/31.863a172e.js"><link rel="prefetch" href="/assets/js/32.7f106482.js"><link rel="prefetch" href="/assets/js/33.b3550db2.js"><link rel="prefetch" href="/assets/js/34.60adfbe3.js"><link rel="prefetch" href="/assets/js/35.b3e49c2d.js"><link rel="prefetch" href="/assets/js/36.cf4f2708.js"><link rel="prefetch" href="/assets/js/37.5570df0f.js"><link rel="prefetch" href="/assets/js/38.192e278e.js"><link rel="prefetch" href="/assets/js/39.bfe3a0a2.js"><link rel="prefetch" href="/assets/js/4.c9424582.js"><link rel="prefetch" href="/assets/js/40.025dc7f7.js"><link rel="prefetch" href="/assets/js/42.72506085.js"><link rel="prefetch" href="/assets/js/43.6a611e38.js"><link rel="prefetch" href="/assets/js/5.43ef4b7c.js"><link rel="prefetch" href="/assets/js/6.6f306ca0.js"><link rel="prefetch" href="/assets/js/7.1ed493ae.js"><link rel="prefetch" href="/assets/js/8.8ccf0c3f.js"><link rel="prefetch" href="/assets/js/9.985d8fde.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7be88f66.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jiay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/about/" class="sidebar-link">about</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>exp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>etd</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>issues</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/issues/cxfclient.html" class="sidebar-link">错误：编码GBK的不可映射字符</a></li><li><a href="/issues/datatable.html" class="active sidebar-link">C# DataTable并发操作:索引超出了数组界限</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/issues/datatable.html#场景" class="sidebar-link">场景</a></li><li class="sidebar-sub-header"><a href="/issues/datatable.html#排查异常原因" class="sidebar-link">排查异常原因</a></li><li class="sidebar-sub-header"><a href="/issues/datatable.html#结论" class="sidebar-link">结论</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>life</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="c-datatable并发操作-索引超出了数组界限"><a href="#c-datatable并发操作-索引超出了数组界限" aria-hidden="true" class="header-anchor">#</a> C# DataTable并发操作:索引超出了数组界限</h1> <h2 id="场景"><a href="#场景" aria-hidden="true" class="header-anchor">#</a> 场景</h2> <p>winform实现的OPC客户端，订阅数据更新时读取DataRow的数据不定时报出索引越界异常，debug模式下监控DataRow对象没有问题，对应索引列上有相应的值。现象非常离奇，异常不定时出现。订阅数据点量大，更新频率毫秒级，调试无法定位到具体原因。</p> <h2 id="排查异常原因"><a href="#排查异常原因" aria-hidden="true" class="header-anchor">#</a> 排查异常原因</h2> <p>很容易就确认是多线程并发读写DataTable有问题，因此首先从DataTable的用法上查找原因。</p> <ul><li>DataTable多线程下使用<br>
程序中多线程处理的地方已经加锁处理，开始以为时锁使用不当，查阅了大量相关资料以及回顾以往的使用经历发现DataTable的应用没有问题。贴出部分代码。</li></ul> <div class="language- extra-class"><pre class="language-text"><code>lock (dt.Columns.SyncRoot)
{
   lock (dt.Rows.SyncRoot)
    {
        DataRow drTarget = dt.NewRow();
        DataRow dr = null;
        try
        {
            for (int i = 0; i &lt; NumItems; i++)
            {
                for (int j = 0; j &lt; itemDic.Count; j++)
                {
                    if (Convert.ToInt32(ClientHandles.GetValue(i + 1)) == Convert.ToInt32(itemDic.Keys.ToArray()[j]))
                    {
                        if (ItemValues.GetValue(i + 1) != null)
                        {
                            var clientHandle = ClientHandles.GetValue(i + 1);
                            dr = dt.AsEnumerable().First(drtemp =&gt; { return drtemp[&quot;clientHandle&quot;].ToString() == clientHandle.ToString(); });
                            if (dr != null)
                            {
                                string drvalue_old = dr[&quot;itemValue&quot;].ToString() == &quot;&quot; ? &quot;0&quot; : dr[&quot;itemValue&quot;].ToString();
                                string drvalue = ItemValues.GetValue(i + 1).ToString();
                                DateTime drtimestamp = DateTime.Parse(TimeStamps.GetValue(i + 1).ToString());
                                setCellValue(dr, &quot;itemValue&quot;, ItemValues.GetValue(i + 1));
                                setCellValue(dr, &quot;itemQuality&quot;, Qualities.GetValue(i + 1));
                                setCellValue(dr, &quot;itemTimeStamp&quot;, drtimestamp);
                                dataUpLoad(upstreamType, itemDic[clientHandle.ToString()], drvalue, drtimestamp.ToString());
                            }
                        }
                    }
                }
            }
        }
    }             
}                                
</code></pre></div><ul><li>Code Review<br>
没有办法，看着日志文件中的异常信息难受，决定从头走查一遍代码。终于发现了端倪，在DataRow对象写操作时采用了异步的方式，看到这时一下觉醒，这里异步就会有问题。</li></ul> <div class="language- extra-class"><pre class="language-text"><code>void setCellValue(DataRow dr, string column, object value)
{
    try
    {
        if (value != null &amp;&amp; value.Equals(&quot;&quot;))
        {
            value = DBNull.Value;
        }
        if (this.InvokeRequired)
        {
            //this.BeginInvoke(new Action(() =&gt; { dr[column] = value; }));//1
            this.Invoke(new Action(() =&gt; { dr[column] = value; }));//2
        }
        else
            dr[column] = value;
    }
    catch (Exception ex)
    {
        MessageBox.Show(ex.Message + &quot; | &quot; + ex.StackTrace);
    }
}
</code></pre></div><p>修改代码用2的方式，测试异常不再出现。上面代码执行委托时1是异步赋值，2是同步赋值，数据处理线程中DataTabel的操作是在锁下进行的，但1的方式委托给另外的线程进行DataRow的异步写操作，这时数据处理线程进行DataRow对象的读操作就可能有问题，所以这里并发出现问题。<br>
查看以前数据采集工具中的用法也是用的第2种形式，所以没碰到该问题。</p> <ul><li>再次出现问题<br>
生产环境中运行一段时间程序UI发生hang，这是因为生产环境数据量大UI线程堵塞了，于是还是要使用异步赋值。更改赋值核心代码解决问题。</li></ul> <div class="language- extra-class"><pre class="language-text"><code>if (this.InvokeRequired)
{
    this.BeginInvoke(new Action(() =&gt; {
        lock (dr.Table.Columns.SyncRoot)
        {
            lock (dr.Table.Rows.SyncRoot)
            {
                dr[column] = value;
            }
        }
    }));
}
</code></pre></div><h2 id="结论"><a href="#结论" aria-hidden="true" class="header-anchor">#</a> 结论</h2> <p>Invoke和BeginInvoke是有很大区别的，使用锁的代码块内部进行委托操作时不要使用异步。如果必须使用异步并发操作对象就要加锁。开始我就是忽略了这一点，并不是DataTable的用法有问题。</p> <div><h2>欢迎来访</h2> <ul><li>有问题欢迎留言或加交流qq:825121848</li> <li>转载请注明出处</li> <li>请小编喝茶~<br><img src="/assets/img/wx.dc92fb1a.png"></li></ul></div> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/16/2022, 11:05:56 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/issues/cxfclient.html" class="prev">
          错误：编码GBK的不可映射字符
        </a></span> <span class="next"><a href="/life/">
          reading
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.92570aa3.js" defer></script><script src="/assets/js/2.cb3e19ad.js" defer></script><script src="/assets/js/41.6ccc4d68.js" defer></script><script src="/assets/js/20.b41657ac.js" defer></script>
  </body>
</html>
